define(["jquery","core/modal_factory","core/templates","core/notification"],function(t,a,e,n){M.cfg.wwwroot;return{init:function(n){t(".block_boasearch .one-resource").each(function(o,c){var i=t(this);i.find(".panel-cover").on("click",function(o){var c=i.data("modal");if(c)c.show();else{var r=t.get(i.data("about")).then(function(a,o,i){return a.custom={},a.custom.preview=function(a){var e,n="";if(a.manifest.alternate&&a.manifest.entrypoint){var o=a.about+"/!/.alternate/"+a.manifest.entrypoint+"/";if(a.metadata.technical.format.match(/video/gi)||a.metadata.technical.format.match(/audio/gi)||a.metadata.technical.format.match(/image/gi)){var c=a.manifest.alternate.find(t=>/small/g.test(t));n=c?o+c:(c=a.manifest.alternate.find(t=>/medium/g.test(t)))?o+c:a.about+"/!/"+a.manifest.entrypoint}else n=(c=a.manifest.alternate.find(t=>/thumb/g.test(t)))?o+c:a.manifest.customicon}else n="technical"in a.manifest&&"format"in a.manifest.technical&&(a.metadata.technical.format.match(/video/gi)||a.metadata.technical.format.match(/audio/gi)||a.metadata.technical.format.match(/image/gi))?a.about+"/!/":a.manifest.customicon;return a.metadata.technical&&a.metadata.technical.format&&(a.metadata.technical.format.match(/video/gi)?(e=t("<video controls><source></source></video>")).find("source").attr("src",n).attr("type",a.metadata.technical.format):a.metadata.technical.format.match(/audio/gi)?(e=t("<audio controls><source></source></audio>")).find("source").attr("src",n).attr("type",a.metadata.technical.format):(e=t("<img />")).attr("src",n).attr("alt",a.metadata.general.title.none)),e.get(0).outerHTML}(a),a.custom.type=a.metadata.technical&&a.metadata.technical.format?a.metadata.technical.format:"",a.custom.score="avg"in a.social.score?a.social.score.avg+"*"+a.social.score.count:0,t.each(n,function(t,e){e.url=e.url.replace("{url}",encodeURI(a.about+"/!/")),e.url=e.url.replace("{name}",a.metadata.general.title.none)}),a.custom.socialnetworks=n,a.custom.alternates=[],t.each(a.manifest.alternate,function(t,e){var n={text:"alternate_"+e.substring(0,e.indexOf("."))in M.str.block_boasearch?M.str.block_boasearch["alternate_"+e.substring(0,e.indexOf("."))]:e,url:a.about+"/!/.alternate/"+a.manifest.entrypoint+"/"+e};a.custom.alternates[a.custom.alternates.length]=n}),e.render("block_boasearch/viewresource",a).then(function(e,n){c.setTitle(a.metadata.general.title.none);var o=t(e);return o.find('[boa-act="rate"]').on("click",function(){var e=t(this),n={value:e.data("value")};t.post(a.about+"/scores",n,function(t){}).done(function(){o.find('[boa-act="rate"]').removeClass("active").each(function(a,n){var o=t(n);o.data("value")<=e.data("value")&&o.addClass("active")})})}),o}).promise()});t(o.currentTarget),a.create({body:r.promise()}).then(function(t){c=t,t.getModal().addClass("block_boasearch-modal"),t.show(),i.data("modal",c)})}})})}}});
