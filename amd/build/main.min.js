function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define ("block_boasearch/main",["jquery","core/modal_factory","core/modal_events","core/templates"],function(a,b,c,d){var e=null;a.boasearch=function(b,c){var d=a(b),e,f=a("<ul class=\"boasearch-suggestions\"></ul>"),g=[],h=[],i=0;d.wrap("<span class=\"boasearch-box\"></span>");e=d.parent();e.append(f);f.customReset=function(){f.empty();f.hide();f.data("off",!0)};f.customReset();if(c.options){c.options=a.extend({},a.boasearch.defaults.options,c.options)}if(c.events){c.events=a.extend({},a.boasearch.defaults.events,c.events)}if(c.results){c.results=a.extend({},a.boasearch.defaults.results,c.results)}d.conf=a.extend({},a.boasearch.defaults,c);d.attr("autocomplete","off");var j=function(a,b){switch(b){case"dev":if(d.conf.debug){console.log("BoASearch - "+a)}break;default:console.log("BoASearch - "+a);}};a.data(b,"boasearch",d);var l={init:function init(){if(!d.conf.apiuri){j("Configuration error: You need set the API URI.");return}d.on("keypress",function(a){if(a.keyCode){switch(a.keyCode){case 13:a.preventDefault();f.customReset();break;case 27:f.customReset();break;case 38:if(!f.data("off")){l.previousItemMarkup()}break;case 40:if(!f.data("off")){l.nextItemMarkup()}break;}}});d.on("keyup",function(a){var b=d.val(),c=[13,16,17,18,27,33,34,35,36,37,38,39,45,144];if(!f.data("off")){c[c.length]=40}if(a.keyCode&&-1==c.indexOf(a.keyCode)){if(b.length>=d.conf.options.minLetters){d.printSuggestions(b)}else{f.customReset()}}else if(13===a.keyCode){d.search()}});e.on("focusout",function(){window.setTimeout(function(){f.customReset()},100)})},getItemMarkup:function getItemMarkup(b,c){var e=""!=b.query?l.highlightString(b.query,c):"",g=a("<li>"+e+"</li>");g.on("click",function(){var b=a(this);f.customReset();d.val(b.text())});return g},highlightString:function highlightString(a,b){var c=a.toLowerCase().indexOf(b.toLowerCase());if(0<=c){var d=a.substr(0,c),e=a.substr(c,b.length),f=a.substr(c+b.length);a=d+"<em>"+e+"</em>"+f}return a},nextItemMarkup:function nextItemMarkup(){var a=f.find(".current"),b,c;if(1>a.length){b=-1}else{b=a.index()}c=b+1;if(f.find("> li").length<=c){c=0}a.removeClass("current");var e=f.children().eq(c);e.addClass("current");d.val(e.text())},previousItemMarkup:function previousItemMarkup(){var a=f.find(".current"),b,c;if(1>a.length){b=-1}else{b=a.index()}c=b-1;if(0>c){c=f.find("> li").length-1}a.removeClass("current");var e=f.children().eq(c);e.addClass("current");d.val(e.text())},printItemsMarkup:function printItemsMarkup(b,c,d){if(0<c.length){a.each(c,function(a,b){var c=l.getItemMarkup(b,d,a);f.append(c)});f.show();f.data("off",!1)}},initSearch:function initSearch(){if("function"==typeof d.conf.events.onstart){d.conf.events.onstart(0<i)}else{if(d.conf.results.target){a(d.conf.results.target).addClass("loading");if(0===i){a(d.conf.results.target).empty()}}}},printResultSearch:function printResultSearch(b){if("function"==typeof d.conf.events.onfound){d.conf.events.onfound(b,i)}else{if(d.conf.results.target){var c=a(d.conf.results.target);c.removeClass("loading");a.each(b,function(b,d){var e=a("<div class=\"boa-video\"></div>"),f=this.choosePreview(d);e.append("<a href=\""+d.about+"\"><h5>"+d.metadata.general.title.none+"</h5></a>");e.append("<a href=\""+d.about+"\"><img src=\""+f+".img\" /></a>");e.append("<p>"+d.metadata.general.description.none+"</p>");c.append(e)})}}},choosePreview:function choosePreview(a){if("alternate"in a.manifest&&a.manifest.entrypoint){var b;if(0<=a.id.indexOf("/content/")){b=a.id.substr(a.id.indexOf("/content/")+9)}else{b=a.manifest.entrypoint}var c=a.about+"/!/.alternate/"+b;if(0<=a.manifest.alternate.indexOf("preview.png")){return c+"/preview.png"}else if(0<=a.manifest.alternate.indexOf("thumb.png")){return c+"/thumb.png"}}return a.about+".img?s=128"}};d.printSuggestions=function(b){for(var c in h){if(c&&"object"===_typeof(c)){c.abort()}}f.customReset();h=[];var e=d.conf.apiuri;e=e.substr(0,e.indexOf("/resources"));e+="/queries.json";var g={q:b,"(n)":d.conf.options.suggestionsSize};if(0<d.conf.filters.length){var i=d.conf.filters.join(" AND ");g.filter=i}h[h.length]=a.get(e,g,function(a){if(0<a.length){a.sort(function(c,a){return a.size-c.size});l.printItemsMarkup("",a,b)}})};d.search=function(){var b=Date.now(),c=d.val();if(c.length<d.conf.options.minLetters){return!1}l.initSearch();if(g[c]&&g[c].timeQuery>b-d.conf.options.cacheLife){l.printResultSearch(g[c].data);return!0}g[c]={timeQuery:b,data:[]};var e={q:c,"(n)":d.conf.options.resultsSize,"(s)":i};if(0<d.conf.filters.length){a.each(d.conf.filters,function(b,c){if("object"==_typeof(c.value)){a.each(c.value,function(a,b){e["(meta)["+c.meta+"]["+a+"]"]=b})}else{e["(meta)["+c.meta+"]"]=c.value}})}a.ajax({url:d.conf.apiuri,data:e,dataType:"json",success:function success(a){f.empty();if("object"===_typeof(a)&&a.error){d.conf.events.onerror(a);a=[]}if(0<a.length){a.sort(function(c,a){return a.size-c.size});g[c].data=a}l.printResultSearch(a)},error:function error(b){var c=b.responseText;d.conf.events.onerror(a.parseJSON(c))},fail:function fail(b){var c=b.responseText;d.conf.events.onerror(a.parseJSON(c))}})};d.searchMore=function(){i+=d.conf.options.resultsSize;d.search()};d.restart=function(){i=0};d.choosePreview=l.choosePreview;l.init()};a.boasearch.defaults={apiuri:null,catalogues:[],filters:[],options:{suggestionsSize:10,resultsSize:10,minLetters:3,cacheLife:6e4},debug:!1,results:{target:null,template:null},events:{onstart:null,onfound:null,onerror:function onerror(a){console.log("BoASearch - search error");console.log(a);return!0}}};a.fn.boasearch=function(b,c){if(b===void 0){b={}}if("object"===_typeof(b)){return this.each(function(){new a.boasearch(this,b)})}else{var d;if("data"in this){d=this.data("boasearch")}else{if("data"in a(this)){d=a(this).data("boasearch")}}if(d){switch(b){case"search":d.search();break;case"nextsearch":d.searchMore();break;case"option":return d.conf.options[c];break;case"restart":d.restart();break;case"choosePreview":return d.choosePreview(c);break;}}else{console.log("Error in boasearch object")}}};var f=function(b){var c;if(b.manifest.conexion_type&&"external"==b.manifest.conexion_type){c=a("<iframe></iframe>");c.attr("src",b.manifest.url);var d=a("<p><a target=\"_blank\"></a></p>");d.find("a").attr("href",b.manifest.url).html(b.manifest.url);return c.get(0).outerHTML+d.get(0).outerHTML}if(b.metadata.technical&&b.metadata.technical.format){if(b.metadata.technical.format.match(/pdf/gi)||b.metadata.technical.format.match(/html/gi)||b.metadata.technical.format.match(/tepuy/gi)){c=a("<iframe></iframe>");c.attr("src",b.about+"/!/").attr("type",b.metadata.technical.format)}else{var e="",f;if(0<=b.id.indexOf("/content/")){f=b.id.substr(b.id.indexOf("/content/")+9)}else{f=b.manifest.entrypoint}if(b.manifest.alternate&&b.manifest.entrypoint){var g=b.about+"/!/.alternate/"+f+"/",h="";if(b.metadata.technical.format.match(/video/gi)||b.metadata.technical.format.match(/audio/gi)||b.metadata.technical.format.match(/image/gi)){if("object"==_typeof(b.manifest.alternate)){h=b.manifest.alternate.find(function(a){return /small/g.test(a)});if(h){e=g+h}else{h=b.manifest.alternate.find(function(a){return /medium/g.test(a)});if(h){e=g+h}else{e=b.about+"/!/"+b.manifest.entrypoint}}}else{e=b.about+"/!/"+b.manifest.entrypoint}}else{h="object"==_typeof(b.manifest.alternate)?b.manifest.alternate.find(function(a){return /thumb/g.test(a)}):"";if(h){e=g+h}else{e=b.manifest.customicon}}}else{if("technical"in b.metadata&&"format"in b.metadata.technical&&(b.metadata.technical.format.match(/video/gi)||b.metadata.technical.format.match(/audio/gi)||b.metadata.technical.format.match(/image/gi))){e=b.about+"/!/"}else{e=b.manifest.customicon}}if(b.metadata.technical.format.match(/video/gi)){c=a("<video controls><source></source></video>");c.find("source").attr("src",e).attr("type",b.metadata.technical.format)}else if(b.metadata.technical.format.match(/audio/gi)){c=a("<audio controls><source></source></audio>");c.find("source").attr("src",e).attr("type",b.metadata.technical.format)}else{c=a("<img />");c.attr("src",e).attr("alt",b.metadata.general.title.none)}}return c.get(0).outerHTML}return c},g=function(a){return!a.manifest.conexion_type||"external"!=a.manifest.conexion_type},h=function(b,c,d,f){c=c?c:"error";d=d?d:"";var g=a("#boa-tpl-error-item")[0].innerHTML;g=g.replace(/{message}/g,b);g=g.replace(/{info}/g,d);g=g.replace(/{type}/g,c);if(f){return g}else{if(e){e.html(g)}else{console.log(g)}}},i=function(b){var c=a("#boa-tpl-item")[0].innerHTML;c=c.replace(/{thumb}/g,b.thumb);c=c.replace(/{title}/g,b.metadata.general.title.none);c=c.replace(/{about}/g,b.about);c=c.replace(/{description}/g,b.metadata.general.description.none);c=c.replace(/{comments}/g,b.social.comments);c=c.replace(/{score}/g,b.social.score.count?b.social.score.sum+"/"+b.social.score.count:0);c=c.replace(/{views}/g,b.social.views);return c};return{init:function init(j,k,l,m){l=l?l:10;a("#"+j).each(function(){var j=a(this),n=j.find("[data-control=\"search-result\"]"),o=j.find("[data-control=\"search-text\"]");e=j.find("[data-control=\"errors-box\"]");j.find("[data-control=\"search-button\"]").on("click",function(){j.find("> .search-result").empty();o.boasearch("restart");o.boasearch("search")});o.boasearch({apiuri:k,catalogues:[],filters:[],options:{cacheLife:2e3,resultsSize:l},events:{onstart:function onstart(a){n.addClass("loading");n.show();if(!a){n.find("> .boa-content").empty()}},onfound:function onfound(e,k){n.removeClass("loading");var l=n.find("> .boa-content"),p=o.boasearch("option","resultsSize");if(0===e.length||e.length<p){n.find("> button").hide()}else{n.find("> button").show()}if(0==k){j.find("[data-control=\"show-one\"]").empty()}if((!e||0===e.length)&&0==k){l.empty();var q=h("No se encontraron resultados","error","",!0);l.append(q);return}a.each(e,function(e,h){if("external"==h.manifest.conexion_type){h.finaluri=h.manifest.url}else{h.finaluri=h.about+"/!/";if(h.manifest.entrypoint){h.finaluri+=h.manifest.entrypoint}}h.thumb=o.boasearch("choosePreview",h);var j=a(i(h));j.appendTo(l);j.find("[boa-href]").on("click",function(){var e=a(this),h=e.data("modal");if(h){h.show();return}var i=a.get(e.attr("boa-href")).then(function(b){b.custom={};b.custom.preview=f(b);b.custom.type=b.metadata.technical&&b.metadata.technical.format?b.metadata.technical.format:"";b.custom.score="avg"in b.social.score?b.social.score.avg+" / "+b.social.score.count:0;b.custom.downloadable=g(b);var c=[];a.each(m,function(a,d){var e=d.url.replace("{url}",encodeURI(b.about+"/!/"));e=e.replace("{name}",b.metadata.general.title.none);var f={url:e,icon:d.icon};c.push(f)});b.custom.socialnetworks=c;b.custom.alternates=[];a.each(b.manifest.alternate,function(a,c){var d,e="alternate_"+c.substring(0,c.indexOf("."));if(e in M.str.block_boasearch){d=M.str.block_boasearch["alternate_"+c.substring(0,c.indexOf("."))]}else{d=c}var f={text:d,url:b.about+"/!/.alternate/"+b.manifest.entrypoint+"/"+c};b.custom.alternates[b.custom.alternates.length]=f});if("object"==_typeof(b.metadata.general.keywords.none)){b.metadata.general.keywords.none=b.metadata.general.keywords.none.join(", ")}var e=d.render("block_boasearch/viewresource",b).then(function(c){h.setTitle(b.metadata.general.title.none);var d=a(c);d.find("[boa-act=\"rate\"]").on("click",function(){var c=a(this),e={value:c.data("value")};a.post(b.about+"/scores",e,function(){}).done(function(){d.find("[boa-act=\"rate\"]").removeClass("active").each(function(b,d){var e=a(d);if(e.data("value")<=c.data("value")){e.addClass("active")}})})});return d});return e.promise()});b.create({body:i.promise()}).then(function(b){h=b;b.getModal().addClass("block_boasearch-modal");b.show();var d=b.getRoot();d.on(c.hidden,function(){a(b.getBody()).find("video").each(function(){this.pause()});a(b.getBody()).find("audio").each(function(){this.pause()});a(b.getBody()).find("iframe").each(function(){var b=a(this);b.attr("src","about:blank");e.data("modal",null)})});e.data("modal",h)})})})},onerror:function onerror(a){var b=e;b.empty();var c=h(a.message,"error",a.info,!0);b.append(c);c.find("button.close").on("click",function(){c.remove()});console.log(a);b.removeClass("loading")}}});n.find("> button").on("click",function(){o.boasearch("nextsearch")})})}}});
//# sourceMappingURL=main.min.js.map
