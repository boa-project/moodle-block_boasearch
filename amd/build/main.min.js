define(["jquery","core/modal_factory","core/templates","core/notification"],function(e,t,a,n){M.cfg.wwwroot;var o=null;e.boasearch=function(t,a){var n,o=e(t),r=e('<ul class="boasearch-suggestions"></ul>'),i=[],s=[],c=0;o.wrap('<span class="boasearch-box"></span>'),(n=o.parent()).append(r),r.customReset=function(){r.empty(),r.hide(),r.data("off",!0)},r.customReset(),a.options&&(a.options=e.extend({},e.boasearch.defaults.options,a.options)),a.events&&(a.events=e.extend({},e.boasearch.defaults.events,a.events)),a.results&&(a.results=e.extend({},e.boasearch.defaults.results,a.results)),o.conf=e.extend({},e.boasearch.defaults,a),o.attr("autocomplete","off");e.data(t,"boasearch",o);var l={init:function(){o.conf.apiuri?(o.on("keypress",function(e){if(e.keyCode)switch(e.keyCode){case 13:e.preventDefault(),r.customReset();break;case 27:r.customReset();break;case 38:r.data("off")||l.previousItemMarkup();break;case 40:r.data("off")||l.nextItemMarkup()}}),o.on("keyup",function(e){var t=o.val(),a=[13,16,17,18,27,33,34,35,36,37,38,39,45,144];r.data("off")||(a[a.length]=40),e.keyCode&&-1==a.indexOf(e.keyCode)?t.length>=o.conf.options.minLetters?o.printSuggestions(t):r.customReset():13===e.keyCode&&o.search()}),n.on("focusout",function(e){window.setTimeout(function(){r.customReset()},100)})):function(e,t){switch(t){case"dev":!o.conf.debug||console.log("BoASearch - "+e);break;default:console.log("BoASearch - "+e)}}("Configuration error: You need set the API URI.")},getItemMarkup:function(t,a,n){var i=""!=t.query?l.highlightString(t.query,a):"",s=e("<li>"+i+"</li>");return s.on("click",function(){var t=e(this);r.customReset(),o.val(t.text())}),s},highlightString:function(e,t){var a=e.toLowerCase().indexOf(t.toLowerCase());if(a>=0){var n=e.substr(0,a),o=e.substr(a,t.length),r=e.substr(a+t.length);e=n+"<em>"+o+"</em>"+r}return e},nextItemMarkup:function(){var e,t=r.find(".current");e=(t.length<1?-1:t.index())+1,r.find("> li").length<=e&&(e=0),t.removeClass("current");var a=r.children().eq(e);a.addClass("current"),o.val(a.text())},previousItemMarkup:function(){var e,t=r.find(".current");(e=(t.length<1?-1:t.index())-1)<0&&(e=r.find("> li").length-1),t.removeClass("current");var a=r.children().eq(e);a.addClass("current"),o.val(a.text())},printItemsMarkup:function(t,a,n){a.length>0&&(e.each(a,function(e,t){var a=l.getItemMarkup(t,n,e);r.append(a)}),r.show(),r.data("off",!1))},initSearch:function(){"function"==typeof o.conf.events.onstart?o.conf.events.onstart(c>0):o.conf.results.target&&(e(o.conf.results.target).addClass("loading"),0===c&&e(o.conf.results.target).empty())},printResultSearch:function(t){if("function"==typeof o.conf.events.onfound)o.conf.events.onfound(t,c);else if(o.conf.results.target){var a=e(o.conf.results.target);a.removeClass("loading"),e.each(t,function(t,n){var o=e('<div class="boa-video"></div>');o.append('<a href="'+n.about+'"><h5>'+n.metadata.general.title.none+"</h5></a>"),o.append('<a href="'+n.about+'"><img src="'+n.about+'.img" /></a>'),o.append("<p>"+n.metadata.general.description.none+"</p>"),a.append(o)})}}};o.printSuggestions=function(t){Date.now();for(var a in s)a&&"object"==typeof a&&a.abort();r.customReset(),s=[];var n=o.conf.apiuri;n=n.substr(0,n.indexOf("/resources")),n+="/queries.json";var i={q:t,"(n)":o.conf.options.suggestionsSize};if(o.conf.filters.length>0){var c=o.conf.filters.join(" AND ");i.filter=c}s[s.length]=e.get(n,i,function(e){e.length>0&&(e.sort(function(e,t){return t.size-e.size}),l.printItemsMarkup("",e,t))})},o.search=function(){var t=Date.now(),a=o.val();if(a.length<o.conf.options.minLetters)return!1;if(l.initSearch(),i[a]&&i[a].timeQuery>t-o.conf.options.cacheLife)return l.printResultSearch(i[a].data),!0;i[a]={timeQuery:t,data:[]};var n={q:a,"(n)":o.conf.options.resultsSize,"(s)":c};o.conf.filters.length>0&&e.each(o.conf.filters,function(t,a){"object"==typeof a.value?e.each(a.value,function(e,t){n["(meta)["+a.meta+"]["+e+"]"]=t}):n["(meta)["+a.meta+"]"]=val}),e.ajax({url:o.conf.apiuri,data:n,dataType:"json",success:function(e){r.empty(),"object"==typeof $data&&$data.error&&(o.conf.events.onerror($data),$data=[]),e.length>0&&(e.sort(function(e,t){return t.size-e.size}),i[a].data=e),l.printResultSearch(e)},error:function(e){var t=e.responseText;o.conf.events.onerror(jQuery.parseJSON(t))},fail:function(e){var t=e.responseText;o.conf.events.onerror(jQuery.parseJSON(t))}})},o.searchMore=function(){c+=o.conf.options.resultsSize,o.search()},o.restart=function(){c=0},l.init()},e.boasearch.defaults={apiuri:null,catalogues:[],filters:[],options:{suggestionsSize:10,resultsSize:10,minLetters:3,cacheLife:6e4},debug:!1,results:{target:null,template:null},events:{onstart:null,onfound:null,onerror:function(e){return console.log("BoASearch - search error"),console.log(e),!0}}},e.fn.boasearch=function(t,a){if(void 0===t&&(t={}),"object"==typeof t)return this.each(function(){new e.boasearch(this,t)});var n;if("data"in this?n=this.data("boasearch"):"data"in e(this)&&(n=e(this).data("boasearch")),n)switch(t){case"search":n.search();break;case"nextsearch":n.searchMore();break;case"option":return n.conf.options[a];case"restart":n.restart()}else console.log("Error in boasearch object")};var r=function(t,a,n,r){a=a||"error",n=n||"";var i=e("#boa-tpl-error-item")[0].innerHTML;if(i=(i=(i=i.replace(/{message}/g,t)).replace(/{info}/g,n)).replace(/{type}/g,a),r)return i;o?o.html(i):console.log(i)};return{init:function(n,i,s,c){s=s||10,e("#"+n).each(function(n,l){var u=e(this),f=u.find('[data-control="search-result"]'),d=u.find('[data-control="search-text"]');o=u.find('[data-control="errors-box"]'),u.find('[data-control="search-button"]').on("click",function(){u.find("> .search-result").empty(),d.boasearch("restart"),d.boasearch("search")}),d.boasearch({apiuri:i,catalogues:[],filters:[],options:{cacheLife:2e3,suggestionsSize:s},events:{onstart:function(e){f.addClass("loading"),f.show(),e||f.find("> .boa-content").empty()},onfound:function(n,o){console.log("Encontrados: "+n.length+" resultados"),f.removeClass("loading");var i=f.find("> .boa-content"),s=d.boasearch("option","resultsSize");if(0===n.length||n.length<s?f.find("> button").hide():f.find("> button").show(),0==o&&u.find('[data-control="show-one"]').empty(),n&&0!==n.length||0!=o)e.each(n,function(n,o){"external"==o.manifest.conexion_type?o.finaluri=o.manifest.url:(o.finaluri=o.about+"/!/",o.manifest.entrypoint&&(o.finaluri+=o.manifest.entrypoint));var r=e(function(t){var a=e("#boa-tpl-item")[0].innerHTML;return a=(a=(a=(a=(a=(a=a.replace(/{title}/g,t.metadata.general.title.none)).replace(/{about}/g,t.about)).replace(/{description}/g,t.metadata.general.description.none)).replace(/{comments}/g,t.social.comments)).replace(/{score}/g,t.social.score.count?t.social.score.sum+"/"+t.social.score.count:0)).replace(/{views}/g,t.social.views)}(o));r.appendTo(i),r.find("[boa-href]").on("click",function(n){var o=e(this),r=o.data("modal");if(r)r.show();else{var i=e.get(o.attr("boa-href")).then(function(t,n,o){return t.custom={},t.custom.preview=function(t){var a;if(t.manifest.conexion_type&&"external"==t.manifest.conexion_type)return(a=e("<iframe></iframe>")).attr("src",t.manifest.url),$reslink=e('<p><a target="_blank"></a></p>'),$reslink.find("a").attr("href",t.manifest.url).html(t.manifest.url),a.get(0).outerHTML+$reslink.get(0).outerHTML;if(t.metadata.technical&&t.metadata.technical.format){if(t.metadata.technical.format.match(/pdf/gi)||t.metadata.technical.format.match(/html/gi)||t.metadata.technical.format.match(/tepuy/gi))(a=e("<iframe></iframe>")).attr("src",t.about+"/!/").attr("type",t.metadata.technical.format);else{var n="";if(t.manifest.alternate&&t.manifest.entrypoint){var o=t.about+"/!/.alternate/"+t.manifest.entrypoint+"/",r="";n=t.metadata.technical.format.match(/video/gi)||t.metadata.technical.format.match(/audio/gi)||t.metadata.technical.format.match(/image/gi)?"object"==typeof t.manifest.alternate?(r=t.manifest.alternate.find(e=>/small/g.test(e)))?o+r:(r=t.manifest.alternate.find(e=>/medium/g.test(e)))?o+r:t.about+"/!/"+t.manifest.entrypoint:t.about+"/!/"+t.manifest.entrypoint:(r="object"==typeof t.manifest.alternate?t.manifest.alternate.find(e=>/thumb/g.test(e)):"")?o+r:t.manifest.customicon}else n="technical"in t.manifest&&"format"in t.manifest.technical&&(t.metadata.technical.format.match(/video/gi)||t.metadata.technical.format.match(/audio/gi)||t.metadata.technical.format.match(/image/gi))?t.about+"/!/":t.manifest.customicon;t.metadata.technical.format.match(/video/gi)?(a=e("<video controls><source></source></video>")).find("source").attr("src",n).attr("type",t.metadata.technical.format):t.metadata.technical.format.match(/audio/gi)?(a=e("<audio controls><source></source></audio>")).find("source").attr("src",n).attr("type",t.metadata.technical.format):(a=e("<img />")).attr("src",n).attr("alt",t.metadata.general.title.none)}return a.get(0).outerHTML}return a}(t),t.custom.type=t.metadata.technical&&t.metadata.technical.format?t.metadata.technical.format:"",t.custom.score="avg"in t.social.score?t.social.score.avg+" / "+t.social.score.count:0,t.custom.downloadable=function(e){return!e.manifest.conexion_type||"external"!=e.manifest.conexion_type}(t),e.each(c,function(e,a){a.url=a.url.replace("{url}",encodeURI(t.about+"/!/")),a.url=a.url.replace("{name}",t.metadata.general.title.none)}),t.custom.socialnetworks=c,t.custom.alternates=[],e.each(t.manifest.alternate,function(e,a){var n={text:"alternate_"+a.substring(0,a.indexOf("."))in M.str.block_boasearch?M.str.block_boasearch["alternate_"+a.substring(0,a.indexOf("."))]:a,url:t.about+"/!/.alternate/"+t.manifest.entrypoint+"/"+a};t.custom.alternates[t.custom.alternates.length]=n}),a.render("block_boasearch/viewresource",t).then(function(a,n){r.setTitle(t.metadata.general.title.none);var o=e(a);return o.find('[boa-act="rate"]').on("click",function(){var a=e(this),n={value:a.data("value")};e.post(t.about+"/scores",n,function(e){}).done(function(){o.find('[boa-act="rate"]').removeClass("active").each(function(t,n){var o=e(n);o.data("value")<=a.data("value")&&o.addClass("active")})})}),o}).promise()});e(n.currentTarget),t.create({body:i.promise()}).then(function(e){r=e,e.getModal().addClass("block_boasearch-modal"),e.show(),o.data("modal",r)})}})});else{i.empty();var l=r("No se encontraron resultados","error","",!0);i.append(l)}},onerror:function(e){var t=o;t.empty();var a=r(e.message,"error",e.info,!0);t.append(a),a.find("button.close").on("click",function(){a.remove()}),console.log(e),t.removeClass("loading")}}}),f.find("> button").on("click",function(){d.boasearch("nextsearch")})})}}});